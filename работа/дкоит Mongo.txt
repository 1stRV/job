в Mongo DB нам надо хранить КИЗы. 
Нам нужно быстро их забирать и они хранятся по документам. 


Как связи поддерживать? 
есть DB Listener. Или хранить документами? Документы большие будут. В фуре 460тыс. пачек. 



Макс написал циклы и там 38палетов, 25коробов, 50блоков, 10пачек и сохраняется это в Mongo DB.






1)Cделать и такую и такую структуру, загнал туда 1000 фур и как быстрее будет искать по КИЗам. Провести экспмеримент и выбрать структуру хранения.


Сохраняется status владельца, status проверили или нет, 

В Mongo храним только текущий статус.  


Например, мы не знаем владельца, пишем не знаем владельца, мы проверили, это наше, мы в Mongo меняем владельца, а все что было до этого мы скидываем в историческую БД(реляционной модели). А предыдущее состояние получаем через Worker. 

2варианта хранения:
1)когда мы List КИЗов делаем, второй вариант когда ссылка на верх. 
Третий вариант ресерч DB ref реляционная ссылка в Mongo. Например, есть КИЗ он ссылается на 321 КИЗ. Самого КИЗа нет и когда ты будешь выборку делать он найде. Когда Макс записал все это в БД. То визуальное отображение зависло. Мбайт получился в палете. 

Надо ресерч какая структура хранения лучше. 
1)иерархическая структура 2)КИЗ ссылкается на родителей. И тогда отдельные КИЗы все. 

Например, задачи:
1)есть большая вложенность найти КИЗ нужно независимо от вложенности первая задача.

2)при изменении статуса КИЗа поменять статусы у всх его родителей.(например, храним короб, блок пачка, как только нам придет инфа о том, что пачка продана, мы понимаем, что больше короба и блока не существует как учетной единицы их распаковали дизагрегировали это называется(агрегация-это собрание)).

При информации о продаже одного из кейсов нам надо родителям проставить признак disagregated. 

*Подумать
проставить disagregated или нам надо разбить все и не хранить больше в структуре.

Для иерархической вещи как мы документами храним или строками храним или ссылками DB refом (это вроде экономит место и не понятно как им управлять). 

*
dDB ref сэкономит место ссылка только по id(описания больше нет) или просто будем строчкой вставлять. 

Дмитрий предлагает взять 20млн пачек записать написать выборки, поиск такой, агргация, посмотреть как она работает. В другом варианте написать поиск, изменения, изменение статусов, добавляется элементы, тоесть были короба, мы запросили информацию о том, какие там блоки, пачки.

Изучить версионность транзакционность Mongo DB, когда update тишь документ.

Например, есть палеты и 1  наш сервис узнал о том, что внутри где-то продали пачку, и в этот же момент другой наш сервис узнал, что продали пачку в другой палет, они оба взяли Entity сохранили и сохранит последний перезапишет. В mongo есть эта фича в Spring. Это операция дороже, не save, другая операция, нужно исследовать.

У документа простовляется версия и он когда сохраняе, когда выбрал он проверяет версию и перед сохранением он лочит изменения и когда сохраняет и если вот эта версия, то сохраняет , а если не эта, то он забирает мержит, изменения или просто удаляет \то надо исследовать. Завести в Confluence.










